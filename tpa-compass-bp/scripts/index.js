import{world as i,Player as m,system as r,TicksPerSecond as l}from"@minecraft/server";import{ActionFormData as d,MessageFormData as c}from"@minecraft/server-ui";i.afterEvents.itemUse.subscribe(({source:e,itemStack:a})=>{if(!(!(e instanceof m)||a.typeId!=="minecraft:compass")){if(e.isSneaking){e.hasTag("prevent")?(e.removeTag("prevent"),e.onScreenDisplay.setActionBar({translate:"tpa:toggle.off"})):(e.addTag("prevent"),e.onScreenDisplay.setActionBar({translate:"tpa:toggle.on"}));return}if(e.hasTag("cooldown")){e.onScreenDisplay.setActionBar({translate:"tpa:ask.cooldown"});return}f(e)}});i.afterEvents.playerSpawn.subscribe(({player:e,initialSpawn:a})=>{a&&r.run(()=>{e.hasTag("asked")&&e.removeTag("asked"),e.hasTag("cooldown")&&e.removeTag("cooldown")})});function f(e){let a=new d().title("tpa:players.list_title").body({translate:"tpa:players.list_body"}),n=i.getAllPlayers();if(n.length<=1){e.sendMessage({translate:"tpa:no_players"});return}let t=n.filter(s=>s.name!==e.name);for(let s of t)a.button(s.name,"textures/ui/players");a.show(e).then(s=>{if(s.canceled||s.selection===void 0)return;let o=t[s.selection];if(o){if(o.hasTag("asked"))return e.sendMessage({translate:"tpa:asked",with:[o.name]});if(o.hasTag("prevent"))return e.sendMessage({translate:"tpa:prevent",with:[o.name]});T(e,o)}else e.sendMessage({translate:"tpa:not_found"})})}function T(e,a){new d().title(a.nameTag).body(" ").button({translate:"tpa:tpa"}).button({translate:"tpa:tpa_here"}).button({translate:"tpa:back"}).show(e).then(t=>{if(!(t.selection===void 0||t.canceled))switch(t.selection){case 0:u(e,a);break;case 1:k(a,e);break;case 2:f(e);break}})}async function u(e,a){let n=new c().body({translate:"tpa:ask.body",with:[a.name]}).button1({translate:"tpa:ask.accept"}).button2({translate:"tpa:ask.reject"});a.addTag("asked");let t=await n.show(e);t.canceled||t.selection===void 0||(t.selection===0?(e.sendMessage({translate:"tpa:accept_player",with:[a.name]}),a.sendMessage({translate:"tpa:accept_target",with:[e.name]}),a?a.teleport(e.location,{dimension:e.dimension}):e.sendMessage({translate:"tpa:not_found"}),e.removeTag("asked"),a.addTag("cooldown"),r.runTimeout(()=>{if(a?.hasTag("cooldown"))return a?.removeTag("cooldown")},l*10)):(a.removeTag("asked"),a.sendMessage({translate:"tpa:reject",with:[e.nameTag]})))}async function k(e,a){let n=new c().body({translate:"tpa:ask_here_body",with:[e.name]}).button1({translate:"tpa:ask.accept"}).button2({translate:"tpa:ask.reject"});e.addTag("asked");let t=await n.show(e);t.canceled||t.selection===void 0||(t.selection===0?(a.sendMessage({translate:"tpa:accept_player",with:[e.name]}),e.sendMessage({translate:"tpa:accept_target",with:[a.name]}),e?a.teleport(e.location,{dimension:e.dimension}):a.sendMessage({translate:"tpa:not_found"}),a.removeTag("asked"),e.addTag("cooldown"),r.runTimeout(()=>{if(e?.hasTag("cooldown"))return e?.removeTag("cooldown")},l*20)):(e.removeTag("asked"),e.sendMessage({translate:"tpa:reject",with:[a.nameTag]})))}
